{"version":3,"sources":["api/getRating.js","api/getPrice.js","contentScript.js"],"names":["getRating","query","Promise","resolve","reject","chrome","runtime","sendMessage","type","messageResponse","response","error","getPrice","initializeScript","window","location","href","includes","appendRating","sWineName","document","getElementsByClassName","innerHTML","isNaN","substring","length","replace","trim","bodyHTML","wines","extractRating","sPrice","Math","round","toFixed","iPriceElements","sPriceDiv","getElementById","querySelectorAll","forEach","tab","style","width","sTabHTML","resultName","resultParentID","resultPrice","resultNumOfReviews","resultTrimmedImage","resultURL","ratingsDesc","resultScore","i","e","console","log","html","elements","DOMParser","parseFromString","nameElements","name","j","textContent","scoreElements","score","numOfReviewsElements","numOfReviews","imageCSSElements","imageCSS","image","trimmedImage","backgroundImage","hrefElements","getElementsByTagName","url","getAttribute","id","split","pop","parentIDElements","parentID","push","parseFloat","addEventListener"],"mappings":"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","file":"contentScript.js","sourceRoot":"../src/contentScript","sourcesContent":["export default function getRating(query) {\n  return new Promise((resolve, reject) => {\n    chrome.runtime.sendMessage(\n      { type: \"getRating\", query },\n      (messageResponse) => {\n        const [response, error] = messageResponse;\n\n        if (!response) {\n          reject(error);\n        }\n\n        resolve(response);\n      }\n    );\n  });\n}\n","export default function getPrice(query) {\n  return new Promise((resolve, reject) => {\n    chrome.runtime.sendMessage(\n      { type: \"getPrice\", query },\n      (messageResponse) => {\n        const [response, error] = messageResponse;\n\n        if (!response) {\n          reject(error);\n        }\n\n        resolve(response);\n      }\n    );\n  });\n}\n","import getRating from \"./api/getRating\";\nimport getPrice from \"./api/getPrice\";\n\n\nfunction initializeScript() {\n  //Only initialize on homepage of lastbottlewines.com or details page for previous listings\n  const shouldInititialize =\n    window.location.href == (\"https://www.lastbottlewines.com/\") || window.location.href.includes(\"https://www.lastbottlewines.com/product/detail/\");\n  if (!shouldInititialize) {\n    return;\n  }\n  appendRating();\n}\n\n//Update the LastBottle DOM with results from Vivino\nasync function appendRating() {\n\n  //Get the name of the wine being offered using the class of the tag. There should only be one.\n  let sWineName = document.getElementsByClassName('offer-name')[0].innerHTML;\n  //To maxmize likelihood of finding a match, remove reference to a specific vintage if one exists.\n  if(!isNaN(sWineName.substring(sWineName.length - 4, sWineName.length))){sWineName = sWineName.substring(0, sWineName.length - 4);}\n  //Clean up the string by removing any references to the wine being non-vintage\n  sWineName = sWineName.replace('NV','').replace('N.V.','');\n  //Finally, trim white space from the string\n  sWineName = sWineName.trim();\n\n  //If we were unable to get the name of the wine being offered, abort mission\n  if (!sWineName) {\n    return;\n  }\n\n  try {\n    //Get rating, review, name, id, image, and link from Vivino\n    const bodyHTML = await getRating(sWineName);\n    //Parse the HTML and return array of results\n    const wines = extractRating(bodyHTML);\n\n    //Get the price value to show in the header. Handle cases where there are no results.\n    //For the header, we round the price to the nearest dollar.\n    let sPrice = 'N/A';\n    if(wines.length>0){\n      sPrice = await getPrice(wines[0]['parentID']);\n      if(!isNaN(sPrice) && sPrice !== null){\n          sPrice = (Math.round(sPrice * 100) / 100).toFixed(0);\n      }\n    }\n\n    //Inject Vivino price into LastBottle\n    let iPriceElements = document.getElementsByClassName('price-holder').length - 1;\n    let sPriceDiv = '<div class=\"price-holder\"><div class=\"strikethrough default\"><em style=\"color:#ed1c24\">$</em><span class=\"amount\" style=\"color:#ed1c24\">' + sPrice + '</span></div><p style=\"color:#ed1c24\">Vivino</p></div>';\n    document.getElementsByClassName('price-holder')[iPriceElements].innerHTML = sPriceDiv + document.getElementsByClassName('price-holder')[iPriceElements].innerHTML;\n\n    //Update the offer-stats div to include a tab that lists the matches from Vivino\n    document.getElementById(\"myTab\").innerHTML += '<li class=\"nav-item offer-tab\" role=\"menuitem\" style=\"width: 33.3%;\"><a class=\"\" id=\"vivino-tab\" data-toggle=\"tab\" href=\"#vivino\" role=\"tab\" aria-controls=\"vivino\" data-uw-rm-brl=\"false\" aria-selected=\"false\">Vivino Results</a></li>';\n    //Resize those tabs\n    const tabs = document.querySelectorAll('.offer-tab');\n    tabs.forEach(tab => {\n      tab.style.width = '33.3%';\n    });\n\n    //Add vivino tab panel content\n    if(!wines){\n      document.getElementById(\"myTabContent\").innerHTML += '<div class=\"tab-pane fade\" id=\"vivino\" role=\"tabpanel\" aria-labelledby=\"vivino\"><div class=\"text-left\"><p data-uw-rm-sr=\"\">No matches found on Vivino. <br role=\"presentation\" data-uw-rm-sr=\"\"></p></div></div>';\n    } else{\n      var sTabHTML;\n      sTabHTML = '<div class=\"tab-pane fade\" id=\"vivino\" role=\"tabpanel\" aria-labelledby=\"vivino\"><div class=\"text-left\"><p data-uw-rm-sr=\"\">';\n      sTabHTML += '<section class=\"details-pane\"></section>';\n      //Declare some variables and then loop through the result set\n      var resultName;\n      var resultParentID;\n      var resultPrice;\n      var resultScore = 'No ratings';\n      var resultNumOfReviews;\n      var resultImage;\n      var resultTrimmedImage;\n      var resultURL;\n      var ratingsDesc;\n\n      //Show a maximum of 5 results. This is a somewhat arbitrary decision but made for a few reasons.\n      // 1. To reduce the time to render results on page\n      // 2. To be mindful of making too many API calls to Vivino\n      // 3. After the first 5 results, the probability of finding a match drops off sharply\n      let i = 0;\n      while (i < wines.length && i<5){\n        //Get values\n        resultName = wines[i]['name'];\n        resultParentID = wines[i]['parentID'];\n        //Make async call go get price\n        resultPrice = await getPrice(resultParentID);\n        resultScore = wines[i]['score'];\n        resultNumOfReviews = wines[i]['numOfReviews'];\n        resultTrimmedImage = wines[i]['trimmedImage'];\n        resultURL = wines[i]['url'];\n        //Apply some formatting\n        if(!isNaN(resultPrice)){\n          resultPrice = '$ ' +resultPrice;\n        }\n        if(!isNaN(resultScore) && resultScore !== null){\n          ratingsDesc = resultScore + '<strong>&#9733;</strong> (' + resultNumOfReviews + ' ratings)';\n        }\n        \n        //Construct HTML\n        sTabHTML += '<section class=\"details-pane\"><h3 data-uw-rm-heading=\"level\" role=\"heading\" aria-level=\"2\">' + resultName + '</h3>';\n        sTabHTML += '<img src=\"' + resultTrimmedImage + '\" alt=\"' + resultName + '\" style=\"height:300px !important;width:auto !important;\">';\n        sTabHTML += '<ul class=\"tech-details\">';\n        sTabHTML += '<li><strong>Average Price</strong>: ' + resultPrice + '</li>';\n        sTabHTML += '<li><strong>Average Rating</strong>: ' + ratingsDesc + '</li>';\n        sTabHTML += '<li><strong>Additional Details</strong>: <a href=\"' + resultURL + '\" target=\"_blank\">Click here</a></li>';\n        sTabHTML += '</ul>';\n        sTabHTML += '</section>';\n\n        i++;\n      };\n      //Close out div and inject HTML\n      sTabHTML += '<br role=\"presentation\" data-uw-rm-sr=\"\">';\n      sTabHTML += '</p></div></div>';\n      document.getElementById(\"myTabContent\").innerHTML += sTabHTML;\n\n    }\n    \n\n  } catch (e) {\n    console.log(`${sWineName} is not found on Vivino`);\n  }\n}\n\n\n//Parse the search results HTML from Vivino and return them as an array.\nconst extractRating = (html) => {\n\n    //Convert HTML String to Document\n    var doc = new DOMParser().parseFromString(html, \"text/html\");\n    \n    // Get elements with class \"card\"\n    let elements = doc.getElementsByClassName(\"card\");\n\n    // Store data on wines in an array\n    let wines = [];\n\n    // Iterate through the search result cards to get values\n    for (let i = 0; i < elements.length; i++) {\n      // Prevent errors by looping through the desired elements if they exist.  Allow max 1 result.\n      \n      // Get the wine name\n      const nameElements = elements[i].getElementsByClassName(\"wine-card__name\");\n      let name = \"\";\n      for (let j = 0; j < nameElements.length && j<1; j++) {\n        name = nameElements[j].textContent.trim();\n      }\n\n      // Get the wine rating\n      const scoreElements = elements[i].getElementsByClassName(\"average__number\");\n      let score = \"\";\n      for (let j = 0; j < scoreElements.length && j<1; j++) {\n        score = scoreElements[j].textContent.trim();\n      }\n      \n      // Get the number of ratings\n      const numOfReviewsElements = elements[i].getElementsByClassName(\"average__stars\");\n      let numOfReviews = \"\";\n      for (let j = 0; j < numOfReviewsElements.length && j<1; j++) {\n        numOfReviews = numOfReviewsElements[j].textContent.replace(\"ratings\",\"\").trim();\n      }\n      \n      // Get the wine image\n      const imageCSSElements = elements[i].getElementsByClassName(\"wine-card__image\");\n      let imageCSS = \"\", image = \"\", trimmedImage = \"\";\n      for (let j = 0; j < imageCSSElements.length && j<1; j++) {\n        imageCSS = imageCSSElements[j].style.backgroundImage;\n        //Get the url from the text\n        image = imageCSS.replace(/^url\\([\"']?/, '').replace(/[\"']?\\)$/, '');\n        //This gets the equivalent image that's used on the product details page. This one is trimmed of white space. \n        trimmedImage = image.replace('300x300','x600');\n      }\n\n      // Get the link to the wine's details page\n      const hrefElements = elements[i].getElementsByTagName(\"a\");\n      let href = \"\", url=\"\";\n      for (let j = 0; j < hrefElements.length && j<1; j++) {\n        href = hrefElements[j].getAttribute(\"href\");\n        url = 'https://www.vivino.com' + href;\n      }\n\n      // Get the wine's ID from the data in the URL\n      let id = url.split(\"/\").pop();\n\n      // Get the wine's parent ID\n      const parentIDElements = elements[i].getElementsByClassName(\"default-wine-card\");\n      let parentID = \"\";\n      for (let j = 0; j < parentIDElements.length; j++) {\n        parentID = parentIDElements[j].getAttribute(\"data-wine\");\n      }\n\n      //NOTE: The price isn't populated on the page itself.  We have to make a seprate call for that.\n\n      //If there is no wine name in this iteration, go ahead and return what we have in the array from previous iterations\n      if (!name) {\n        return;\n      }\n      \n      //Push the results from this iteration into the array\n      wines.push({\n        id,\n        parentID,\n        name,\n        score: parseFloat(score),\n        numOfReviews: parseFloat(numOfReviews),\n        image,\n        trimmedImage,\n        url,\n      });\n\n      //End loop\n    }\n\n    return wines;\n    \n};\n\n//Add an event listener to the page\nwindow.addEventListener(\"load\", initializeScript);\n\n\n"]}